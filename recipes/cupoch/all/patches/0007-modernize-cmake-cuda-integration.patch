From 95fbda640a335fdae641bd399a2a741780fbad03 Mon Sep 17 00:00:00 2001
From: Martin Valgur <martin.valgur@gmail.com>
Date: Sat, 4 Oct 2025 20:57:13 +0300
Subject: [PATCH 7/9] modernize cmake cuda integration

---
 CMakeLists.txt                          | 18 ++++++------------
 src/cupoch/camera/CMakeLists.txt        |  2 +-
 src/cupoch/collision/CMakeLists.txt     |  2 +-
 src/cupoch/geometry/CMakeLists.txt      |  2 +-
 src/cupoch/imageproc/CMakeLists.txt     |  2 +-
 src/cupoch/integration/CMakeLists.txt   |  2 +-
 src/cupoch/io/CMakeLists.txt            |  2 +-
 src/cupoch/kinfu/CMakeLists.txt         |  2 +-
 src/cupoch/knn/CMakeLists.txt           |  2 +-
 src/cupoch/odometry/CMakeLists.txt      |  2 +-
 src/cupoch/planning/CMakeLists.txt      |  2 +-
 src/cupoch/registration/CMakeLists.txt  |  2 +-
 src/cupoch/utility/CMakeLists.txt       |  2 +-
 src/cupoch/visualization/CMakeLists.txt |  2 +-
 src/python/CMakeLists.txt               |  2 +-
 15 files changed, 20 insertions(+), 26 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index caf9174..791114b 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -1,4 +1,4 @@
-cmake_minimum_required(VERSION 3.0.0)
+cmake_minimum_required(VERSION 3.27)
 
 if (NOT CMAKE_VERSION VERSION_LESS "3.1")
     cmake_policy(SET CMP0054 NEW)
@@ -19,7 +19,7 @@ string(CONCAT CUPOCH_VERSION "${CUPOCH_VERSION_MAJOR}"
                              ".${CUPOCH_VERSION_MINOR}"
                              ".${CUPOCH_VERSION_PATCH}"
                              ".${CUPOCH_VERSION_TWEAK}")
-project(cupoch VERSION ${CUPOCH_VERSION})
+project(cupoch VERSION ${CUPOCH_VERSION} LANGUAGES CXX CUDA)
 message(STATUS "cupoch ${PROJECT_VERSION}")
 
 # npm version has to be MAJOR.MINOR.PATCH
@@ -159,16 +159,9 @@ elseif (UNIX)
     message(STATUS "Compiling on Unix")
 endif ()
 
-find_package(CUDA REQUIRED)
-if(NOT CMAKE_CUDA_ARCHITECTURES)
-  set(CMAKE_CUDA_ARCHITECTURES 86)
-endif()
-include(${CMAKE_SOURCE_DIR}/cmake/CudaComputeTargetFlags.cmake)
-APPEND_TARGET_ARCH_FLAGS()
-if (NOT cuda_nvcc_target_flags)
-  set(CUDA_NVCC_FLAGS ${CUDA_NVCC_FLAGS} -arch=sm_52 -std=c++17)
-endif ()
-include_directories(${CUDA_INCLUDE_DIRS})
+find_package(CUDAToolkit REQUIRED)
+
+link_libraries(CUDA::cudart)
 set(CMAKE_CUDA_COMPILE_FEATURES cuda_std_17)
 set(CUDA_NVCC_FLAGS ${CUDA_NVCC_FLAGS}
     --expt-relaxed-constexpr
@@ -178,6 +171,7 @@ set(CUDA_NVCC_FLAGS ${CUDA_NVCC_FLAGS}
     -Xcudafe "--diag_suppress=integer_sign_change"
     -Xcudafe "--diag_suppress=partial_override"
     -Xcudafe "--diag_suppress=virtual_function_decl_hidden")
+string(REPLACE ";" " " CMAKE_CUDA_FLAGS "${CUDA_NVCC_FLAGS}")
 if (USE_RMM)
     add_definitions(-DUSE_RMM)
 endif ()
diff --git a/src/cupoch/camera/CMakeLists.txt b/src/cupoch/camera/CMakeLists.txt
index 320fb2c..ac19815 100644
--- a/src/cupoch/camera/CMakeLists.txt
+++ b/src/cupoch/camera/CMakeLists.txt
@@ -1,2 +1,2 @@
 file(GLOB_RECURSE CAMERA_SOURCE_FILES "*.cpp")
-cuda_add_library(cupoch_camera ${CAMERA_SOURCE_FILES})
\ No newline at end of file
+add_library(cupoch_camera ${CAMERA_SOURCE_FILES})
diff --git a/src/cupoch/collision/CMakeLists.txt b/src/cupoch/collision/CMakeLists.txt
index 6485b39..72e4274 100644
--- a/src/cupoch/collision/CMakeLists.txt
+++ b/src/cupoch/collision/CMakeLists.txt
@@ -1,4 +1,4 @@
 file(GLOB_RECURSE COLLISION_SOURCE_FILES "*.cu")
-cuda_add_library(cupoch_collision ${COLLISION_SOURCE_FILES})
+add_library(cupoch_collision ${COLLISION_SOURCE_FILES})
 target_link_libraries(cupoch_collision cupoch_geometry
                       ${3RDPARTY_LIBRARIES})
\ No newline at end of file
diff --git a/src/cupoch/geometry/CMakeLists.txt b/src/cupoch/geometry/CMakeLists.txt
index 85812d5..3c0912f 100644
--- a/src/cupoch/geometry/CMakeLists.txt
+++ b/src/cupoch/geometry/CMakeLists.txt
@@ -1,5 +1,5 @@
 file(GLOB_RECURSE GEOMETRY_SOURCE_FILES "*.cu")
-cuda_add_library(cupoch_geometry ${GEOMETRY_SOURCE_FILES})
+add_library(cupoch_geometry ${GEOMETRY_SOURCE_FILES})
 target_link_libraries(cupoch_geometry cupoch_knn
                       cupoch_camera
                       ${3RDPARTY_LIBRARIES})
\ No newline at end of file
diff --git a/src/cupoch/imageproc/CMakeLists.txt b/src/cupoch/imageproc/CMakeLists.txt
index fde71cf..a737841 100644
--- a/src/cupoch/imageproc/CMakeLists.txt
+++ b/src/cupoch/imageproc/CMakeLists.txt
@@ -1,4 +1,4 @@
 file(GLOB_RECURSE IMAGEPROC_SOURCE_FILES "*.cpp")
-cuda_add_library(cupoch_imageproc ${IMAGEPROC_SOURCE_FILES})
+add_library(cupoch_imageproc ${IMAGEPROC_SOURCE_FILES})
 target_link_libraries(cupoch_imageproc cupoch_geometry
                       ${3RDPARTY_LIBRARIES})
\ No newline at end of file
diff --git a/src/cupoch/integration/CMakeLists.txt b/src/cupoch/integration/CMakeLists.txt
index bf329f3..e77428b 100644
--- a/src/cupoch/integration/CMakeLists.txt
+++ b/src/cupoch/integration/CMakeLists.txt
@@ -2,5 +2,5 @@
 file(GLOB_RECURSE ALL_CUDA_SOURCE_FILES "*.cu")
 
 # create object library
-cuda_add_library(cupoch_integration ${ALL_CUDA_SOURCE_FILES})
+add_library(cupoch_integration ${ALL_CUDA_SOURCE_FILES})
 target_link_libraries(cupoch_integration cupoch_geometry)
\ No newline at end of file
diff --git a/src/cupoch/io/CMakeLists.txt b/src/cupoch/io/CMakeLists.txt
index 3ababba..a815554 100644
--- a/src/cupoch/io/CMakeLists.txt
+++ b/src/cupoch/io/CMakeLists.txt
@@ -3,7 +3,7 @@ file(GLOB_RECURSE IO_CUDA_SOURCE_FILES "*.cu")
 set(IO_ALL_SOURCE_FILES ${IO_CPP_SOURCE_FILES} ${IO_CUDA_SOURCE_FILES})
 
 # Create object library
-cuda_add_library(cupoch_io ${IO_ALL_SOURCE_FILES})
+add_library(cupoch_io ${IO_ALL_SOURCE_FILES})
 target_link_libraries(cupoch_io cupoch_geometry
                       cupoch_utility
                       ${3RDPARTY_LIBRARIES})
\ No newline at end of file
diff --git a/src/cupoch/kinfu/CMakeLists.txt b/src/cupoch/kinfu/CMakeLists.txt
index b961e65..470d32a 100644
--- a/src/cupoch/kinfu/CMakeLists.txt
+++ b/src/cupoch/kinfu/CMakeLists.txt
@@ -1,7 +1,7 @@
 file(GLOB_RECURSE KINFU_SOURCE_FILES "*.cpp")
 
 # Create object library
-cuda_add_library(cupoch_kinfu ${KINFU_SOURCE_FILES})
+add_library(cupoch_kinfu ${KINFU_SOURCE_FILES})
 target_link_libraries(cupoch_kinfu cupoch_integration
                       cupoch_registration
                       ${3RDPARTY_LIBRARIES})
\ No newline at end of file
diff --git a/src/cupoch/knn/CMakeLists.txt b/src/cupoch/knn/CMakeLists.txt
index bdca2c0..92ee423 100644
--- a/src/cupoch/knn/CMakeLists.txt
+++ b/src/cupoch/knn/CMakeLists.txt
@@ -2,5 +2,5 @@
 file(GLOB_RECURSE ALL_CUDA_SOURCE_FILES "*.cu")
 
 # create object library
-cuda_add_library(cupoch_knn ${ALL_CUDA_SOURCE_FILES})
+add_library(cupoch_knn ${ALL_CUDA_SOURCE_FILES})
 target_link_libraries(cupoch_knn cupoch_utility)
\ No newline at end of file
diff --git a/src/cupoch/odometry/CMakeLists.txt b/src/cupoch/odometry/CMakeLists.txt
index 6871b68..fa5cd44 100644
--- a/src/cupoch/odometry/CMakeLists.txt
+++ b/src/cupoch/odometry/CMakeLists.txt
@@ -2,5 +2,5 @@
 file(GLOB_RECURSE ALL_CUDA_SOURCE_FILES "*.cu")
 
 # create object library
-cuda_add_library(cupoch_odometry ${ALL_CUDA_SOURCE_FILES})
+add_library(cupoch_odometry ${ALL_CUDA_SOURCE_FILES})
 target_link_libraries(cupoch_odometry cupoch_geometry)
\ No newline at end of file
diff --git a/src/cupoch/planning/CMakeLists.txt b/src/cupoch/planning/CMakeLists.txt
index 397e305..4334a43 100644
--- a/src/cupoch/planning/CMakeLists.txt
+++ b/src/cupoch/planning/CMakeLists.txt
@@ -1,3 +1,3 @@
 file(GLOB_RECURSE ALL_CUDA_SOURCE_FILES "*.cu")
-cuda_add_library(cupoch_planning ${ALL_CUDA_SOURCE_FILES})
+add_library(cupoch_planning ${ALL_CUDA_SOURCE_FILES})
 target_link_libraries(cupoch_planning cupoch_collision)
\ No newline at end of file
diff --git a/src/cupoch/registration/CMakeLists.txt b/src/cupoch/registration/CMakeLists.txt
index 372484b..01f5d58 100644
--- a/src/cupoch/registration/CMakeLists.txt
+++ b/src/cupoch/registration/CMakeLists.txt
@@ -1,3 +1,3 @@
 file(GLOB_RECURSE ALL_CUDA_SOURCE_FILES "*.cu")
-cuda_add_library(cupoch_registration ${ALL_CUDA_SOURCE_FILES})
+add_library(cupoch_registration ${ALL_CUDA_SOURCE_FILES})
 target_link_libraries(cupoch_registration cupoch_geometry)
\ No newline at end of file
diff --git a/src/cupoch/utility/CMakeLists.txt b/src/cupoch/utility/CMakeLists.txt
index 611256c..e1f1632 100644
--- a/src/cupoch/utility/CMakeLists.txt
+++ b/src/cupoch/utility/CMakeLists.txt
@@ -1,4 +1,4 @@
 file(GLOB_RECURSE ALL_CPP_SOURCE_FILES "*.cpp")
 file(GLOB_RECURSE ALL_CUDA_SOURCE_FILES "*.cu")
-cuda_add_library(cupoch_utility ${ALL_CUDA_SOURCE_FILES} ${ALL_CPP_SOURCE_FILES})
+add_library(cupoch_utility ${ALL_CUDA_SOURCE_FILES} ${ALL_CPP_SOURCE_FILES})
 target_link_libraries(cupoch_utility ${3RDPARTY_LIBRARIES})
\ No newline at end of file
diff --git a/src/cupoch/visualization/CMakeLists.txt b/src/cupoch/visualization/CMakeLists.txt
index e113cd5..ab24503 100644
--- a/src/cupoch/visualization/CMakeLists.txt
+++ b/src/cupoch/visualization/CMakeLists.txt
@@ -25,6 +25,6 @@ file(GLOB_RECURSE VISUALIZATION_CPP_SOURCE_FILES "*.cpp")
 file(GLOB_RECURSE VISUALIZATION_CUDA_SOURCE_FILES "*.cu")
 
 # create object library
-cuda_add_library(cupoch_visualization ${VISUALIZATION_CUDA_SOURCE_FILES} ${VISUALIZATION_CPP_SOURCE_FILES})
+add_library(cupoch_visualization ${VISUALIZATION_CUDA_SOURCE_FILES} ${VISUALIZATION_CPP_SOURCE_FILES})
 target_link_libraries(cupoch_visualization cupoch_geometry cupoch_io cupoch_camera ${3RDPARTY_LIBRARIES})
 add_dependencies(cupoch_visualization shader_file_target)
\ No newline at end of file
diff --git a/src/python/CMakeLists.txt b/src/python/CMakeLists.txt
index 80343af..26b9f69 100644
--- a/src/python/CMakeLists.txt
+++ b/src/python/CMakeLists.txt
@@ -6,7 +6,7 @@ add_library(${PACKAGE_NAME} SHARED
     ${PY_ALL_SOURCE_FILES}
 )
 
-cuda_add_library(cupoch_wrapper cupoch_pybind/device_vector_wrapper.cu
+add_library(cupoch_wrapper cupoch_pybind/device_vector_wrapper.cu
     cupoch_pybind/device_map_wrapper.cu)
 target_include_directories(cupoch_wrapper PRIVATE
     ${CMAKE_CURRENT_SOURCE_DIR}
-- 
2.43.0

